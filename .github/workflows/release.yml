name: Build and Release

on:
  push:
    tags:
      - 'v*'  # 当推送以 v 开头的 tag 时触发（例如: v1.0.0）
  workflow_dispatch:  # 允许手动触发
    inputs:
      version:
        description: '版本号 (例如: 1.0.0)'
        required: true
        default: '1.0.0'

jobs:
  build:
    name: Build fastls-mitm
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            goos: windows
            goarch: amd64
            ext: .exe
          - os: windows-latest
            goos: windows
            goarch: 386
            ext: .exe
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            ext: ''
          - os: ubuntu-latest
            goos: linux
            goarch: 386
            ext: ''
          - os: ubuntu-latest
            goos: linux
            goarch: arm64
            ext: ''
          - os: macos-latest
            goos: darwin
            goarch: amd64
            ext: ''
          - os: macos-latest
            goos: darwin
            goarch: arm64
            ext: ''

    steps:
      - name: Checkout parent repository
        uses: actions/checkout@v4
        with:
          repository: FastTLS/fastls
          path: workspace
          fetch-depth: 0

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: workspace/services/fastls-mitm
          fetch-depth: 0

      - name: Set up directory structure
        shell: bash
        run: |
          set -e
          # 验证目录结构
          echo "检查父项目目录..."
          if [ ! -d "workspace" ]; then
            echo "错误: 父项目目录不存在"
            exit 1
          fi
          echo "父项目目录存在，列出前10个文件/目录:"
          find workspace -maxdepth 1 -type f -o -type d | head -10 || echo "无法列出文件"
          
          echo "检查子项目目录..."
          if [ ! -d "workspace/services/fastls-mitm" ]; then
            echo "错误: 子项目目录不存在"
            exit 1
          fi
          echo "子项目目录存在，列出前10个文件/目录:"
          find workspace/services/fastls-mitm -maxdepth 1 -type f -o -type d | head -10 || echo "无法列出文件"
          
          # 验证 go.mod 文件
          echo "检查父项目 go.mod..."
          if [ -f "workspace/go.mod" ]; then
            echo "父项目 go.mod 存在，前5行:"
            head -5 workspace/go.mod || sed -n '1,5p' workspace/go.mod
          else
            echo "错误: 父项目 go.mod 不存在"
            exit 1
          fi
          
          echo "检查子项目 go.mod..."
          if [ -f "workspace/services/fastls-mitm/go.mod" ]; then
            echo "子项目 go.mod 存在，内容:"
            cat workspace/services/fastls-mitm/go.mod
          else
            echo "错误: 子项目 go.mod 不存在"
            exit 1
          fi
          
          # 确保 go.mod 中的 replace 指令能够找到父项目
          # replace github.com/FastTLS/fastls => ../../ 应该指向 workspace/

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Prepare dependencies
        working-directory: workspace
        env:
          GOWORK: off
        run: |
          # 下载父项目的所有依赖
          echo "下载父项目依赖..."
          go mod download
          
          # 整理依赖（这会更新 go.sum，确保包含所有间接依赖）
          echo "整理父项目依赖..."
          go mod tidy
          
          # 尝试构建父项目以生成完整的 go.sum
          # 使用 -mod=readonly 避免修改 go.mod，但会生成 go.sum
          echo "构建父项目以生成完整的 go.sum..."
          go build -mod=readonly ./... 2>&1 | head -50 || true
          
          # 如果构建失败，尝试下载所有可能的依赖
          echo "下载所有可能的依赖..."
          go list -m -json all 2>&1 | head -20 || true
          go mod download
          
          # 再次整理依赖，确保 go.sum 包含所有构建时发现的依赖
          echo "再次整理依赖..."
          go mod tidy
          
          # 再次下载确保所有依赖都在 go.sum 中
          echo "最终下载依赖..."
          go mod download
          
          # 显示 go.sum 文件信息
          if [ -f "go.sum" ]; then
            echo "go.sum 文件已更新:"
            ls -lh go.sum
            echo "go.sum 行数: $(wc -l < go.sum)"
          else
            echo "警告: go.sum 文件不存在"
          fi

      - name: Get version from tag
        id: get_version
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Get version from input
        id: get_version_input
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          echo "Version: ${{ github.event.inputs.version }}"

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
          GOWORK: off
        shell: bash
        working-directory: workspace/services/fastls-mitm
        run: |
          # 先下载所有依赖，确保 go.sum 完整
          echo "下载子项目依赖..."
          go mod download
          
          # 整理依赖以确保 go.sum 包含所有间接依赖
          echo "整理子项目依赖..."
          go mod tidy
          
          # 再次下载确保所有依赖都在 go.sum 中
          echo "再次下载依赖..."
          go mod download
          
          # 开始构建
          VERSION="${{ steps.get_version.outputs.version || steps.get_version_input.outputs.version || 'dev' }}"
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          COMMIT_SHA=${GITHUB_SHA::8}
          
          OUTPUT_NAME="fastls-mitm${{ matrix.ext }}"
          
          echo "开始构建: $OUTPUT_NAME"
          go build -ldflags "-s -w -X 'main.version=$VERSION' -X 'main.buildTime=$BUILD_TIME' -X 'main.gitCommit=$COMMIT_SHA'" \
            -o "$OUTPUT_NAME" .
          
          echo "构建完成: $OUTPUT_NAME"
          if [ "${{ matrix.goos }}" = "windows" ]; then
            dir "$OUTPUT_NAME"
          else
            ls -lh "$OUTPUT_NAME"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: fastls-mitm-${{ matrix.goos }}-${{ matrix.goarch }}
          path: workspace/services/fastls-mitm/fastls-mitm${{ matrix.ext }}
          retention-days: 30

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"
          
          # 检查是否为 beta/alpha/rc 版本
          if [[ "$VERSION" =~ (beta|alpha|rc) ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "检测到预发布版本: $VERSION"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          cd artifacts
          for dir in */; do
            platform=$(basename "$dir")
            file=$(find "$dir" -type f -name "fastls-mitm*" | head -1)
            if [ -n "$file" ]; then
              filename=$(basename "$file")
              cp "$file" "../release/fastls-mitm-$platform-${{ steps.get_version.outputs.version }}"
              if [[ "$filename" == *.exe ]]; then
                mv "../release/fastls-mitm-$platform-${{ steps.get_version.outputs.version }}" \
                   "../release/fastls-mitm-$platform-${{ steps.get_version.outputs.version }}.exe"
              fi
            fi
          done
          cd ../release
          ls -lh

      - name: Create checksums
        run: |
          cd release
          for file in *; do
            if [ -f "$file" ] && [[ ! "$file" == *.sha256 ]]; then
              sha256sum "$file" > "${file}.sha256"
            fi
          done
          ls -lh

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: fastls-mitm v${{ steps.get_version.outputs.version }}
          body: |
            ## fastls-mitm v${{ steps.get_version.outputs.version }}
            
            ### 下载
            
            请根据您的操作系统下载对应的可执行文件：
            
            - **Windows**: `fastls-mitm-windows-*.exe`
            - **Linux**: `fastls-mitm-linux-*`
            - **macOS**: `fastls-mitm-darwin-*`
            
            ### 使用说明
            
            1. 下载对应平台的可执行文件
            2. 重命名为 `fastls-mitm` (Linux/macOS) 或 `fastls-mitm.exe` (Windows)
            3. 添加执行权限 (Linux/macOS): `chmod +x fastls-mitm`
            4. 运行: `./fastls-mitm -addr :8888 -browser chrome142`
            
            详细使用说明请参考 [README.md](README.md)
            
            ### 校验
            
            下载后请使用对应的 `.sha256` 文件校验文件完整性：
            
            ```bash
            # Linux/macOS
            sha256sum -c fastls-mitm-*.sha256
            
            # Windows (PowerShell)
            Get-FileHash fastls-mitm-*.exe | Format-List
            ```
          files: release/*
          draft: false
          prerelease: ${{ steps.get_version.outputs.is_prerelease == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.SECRET_TOKEN }}

